var Grid,__indexOf=[].indexOf||function(t){for(var i=0,n=this.length;n>i;i++)if(i in this&&this[i]===t)return i;return-1};Grid=function(t,i,n){var e,s,r,h,o,u,l,a;if(null==i&&(i=[]),null==n&&(n={}),u=[i,{},document.querySelector(t),{},[],this],this.data=u[0],this.lookup=u[1],this.element=u[2],this.tiles=u[3],this.cache=u[4],e=u[5],l=[[],0,0,0,0,0],this.path=l[0],this.current=l[1],this.q=l[2],this.length=l[3],this.w=l[4],this.h=l[5],null==this.element)return!1;for(a=this.data,s=h=0,o=a.length;o>h;s=++h)r=a[s],this.lookup[r.id]=r;return this.options=extend({size:30,distance:2,before:2,after:2,space:0,onMove:!1,onSnap:!1,onChange:!1,onEnd:!1,onEnter:!1,onLeave:!1},n),this.init=function(){var t,i,n,s,r,h,o;return this.element.innerHTML='<div class="grid-wrap"><div class="grid-box"></div></div>',s=this.element.querySelector(".grid-wrap"),this.box=this.element.querySelector(".grid-box"),this.generate(),r=[3*this.options.size/2,this.options.size*Math.sqrt(3)],this.w=r[0],this.h=r[1],h=[(this.w+this.options.space)*(this.length+2),(this.h+this.options.space)*(2*this.options.distance+1.5)],this.width=h[0],this.height=h[1],this.svg=element("svg",{"class":"grid",width:this.width,height:this.height}),this.box.appendChild(this.svg),this.svg.style.position="relative",(t=function(){return e.svg.style.top=((e.box.clientHeight||e.box.offsetHeight())-e.height)/2+"px"})(),window.addEventListener("resize",function(){return requestAnimFrame(t)}),this.setCurrent(this.find(0)),o=[new Hammer(this.element.querySelector(".grid-wrap")),0],i=o[0],n=o[1],i.on("panstart",function(t){return n=e.getPos(e.q),null!=e.options.onMove.call?e.options.onMove.call(e,e.q):void 0}),i.on("pan",function(t){return requestAnimFrame(function(){var i;return e.show(e.getLine(i=Math.min(e.getPos(0),Math.max(e.getPos(e.length),n-3*t.deltaY)))),t.isFinal?e.snap(i,e.getPos(e.q)):e.move(i),t.isFinal&&null!=e.options.onSnap.call?e.options.onSnap.call(e,e.q,e.q>e.length-3&&e.current.q===e.length):void 0})}),i.get("pan").set({direction:Hammer.DIRECTION_VERTICAL})},this.slide=function(t){return null==t&&(t=!0),this.show(this.q+[1,-1][[!0,!1].indexOf(t)]),this.move(this.getPos(this.q))},this.progress=function(t){var i,n,e,s;return null==t&&(t=!0),this.current.q>=this.length?void 0:(s=[Math.min(this.current.q+1,this.length-1),this.next(this.current),[!0,!1].indexOf(t)],e=s[0],n=s[1],i=s[2],1===n.length?i=0:null!=n[i%2]&&this.t(n[i%2])===!1&&i++,this.setCurrent(this.next(this.current)[i%2]))},this.setCurrent=function(t){var i,n,s,r,h;return r=[this.current.r+this.current.q%2<=t.r,this.getPos(this.current.q),t],i=r[0],s=r[1],this.current=r[2],this.snap(s,this.getPos(t.q)),h=n=this.tok(this.current),__indexOf.call(this.path,h)<0&&this.path.push(n),this.show(this.current.q),null!=this.options.onChange.call?this.options.onChange.call(e,this.t(t),t,i,this.get(t),this.current.q===this.length):void 0},this.show=function(t){var i,n,h,o,u,l,a,c,f,p,d,g,v,q,m;for(t=Math.max(0,Math.min(this.length,t)),p=[t,function(){q=[];for(var i=f=Math.max(0,t-this.options.before),n=Math.min(t+this.options.after,this.length);n>=f?n>=i:i>=n;n>=f?i++:i--)q.push(i);return q}.apply(this)],this.q=p[0],n=p[1],h=0,u=n.length;u>h;h++)s=n[h],null==document.getElementById("gl"+s)&&this.svg.appendChild(this.line(s));for(d=[].slice.call(this.svg.childNodes,0),o=0,l=d.length;l>o;o++)i=d[o],g=parseInt(i.id.slice(2)),__indexOf.call(n,g)<0&&this.svg.removeChild(i);if(this.current.q>=n[0]){for(v=this.path.filter(function(t){var i;return i=e.toc(t).q,__indexOf.call(n,i)>=0}).map(function(t){return e.svg.querySelector("#gt"+t)}),m=[],c=0,a=v.length;a>c;c++)r=v[c],-1===r.getAttribute("class").indexOf("tile-through")&&r.setAttribute("class",r.getAttribute("class")+" tile-through"),r.getAttribute("class").indexOf("tile-current")>-1&&r.setAttribute("class",r.getAttribute("class").replace("tile-current","")),m.push(r.id.slice(2)===this.tok(this.current)?r.setAttribute("class",r.getAttribute("class")+" tile-current"):void 0);return m}},this.getLine=function(t){return Math.floor(-t/(this.w+this.options.space))},this.getPos=function(t){return-t*(this.w+this.options.space)},this.snap=function(i,n){return t=n-i,animate(function(n){return e.move(i+t*n,1===n)},300,function(t){return--t*t*t+1})},this.move=function(t){return e.svg.style.webkitTransform=e.svg.style.transform="translateX("+t+"px)"},this.skip=function(){var t,i,n,e,r,h;for(r=[Object.keys(this.tiles),0],n=r[0],s=r[1];!t;)h=[n[s],this.tiles[n[s]],s+1],i=h[0],e=h[1],s=h[2],e!==!1&&__indexOf.call(this.path,i)<0&&this.path.push(i),-1!==e&&e!==!1&&"tutoriel"!==this.lookup[e].context&&(t=this.toc(i));return this.setCurrent(t)},this.line=function(t){var i,n,e,s;if(null!=(i=this.cache[t]))return i;for(i=element("g",{"class":"grid-line",id:"gl"+t}),n=e=0,s=2*this.options.distance;s>=0?s>=e:e>=s;n=s>=0?++e:--e)i.appendChild(this.tile(this.c(t,n)));return i},this.tile=function(t){var i,n,s,r,h;return i=this.t(t)===!1?"tile-disabled":this.get(t).checkpoint?"tile-checkpoint":this.t(t)>-1?"tile-item":"tile",this.get(t).context&&(i+=" tile-"+this.get(t).context),h=[(t.q+1)*this.w+t.q*this.options.space,this.height/2+(t.r-this.options.distance+t.q%2/2-.25)*this.h+(t.r-this.options.distance+t.q%2/2)*this.options.space],s=h[0],r=h[1],n=element("polygon",{id:"gt"+this.tok(t),"class":i,points:this.points({x:s,y:r})}),n.addEventListener("touchstart",function(i){if(i.stopPropagation(),i.preventDefault(),e["double"](e.tok(t))(e.goTo(t)));else if(null!=e.options.onEnter.call)return e.options.onEnter.call(e,i,e.t(t),t,e.get(t))}),n.addEventListener("click",function(i){return e.goTo(t)}),n.addEventListener("mouseenter",function(i){return null!=e.options.onEnter.call?e.options.onEnter.call(e,i,e.t(t),t,e.get(t)):void 0}),n.addEventListener("mouseleave",function(i){return null!=e.options.onLeave.call?e.options.onLeave.call(e,i,e.t(t),t,e.get(t)):void 0}),n},this.goTo=function(t){return requestAnimFrame(function(){var i;return i=e.next(e.current).filter(function(i){return e.t(i)!==!1&&e["in"](i,e.current,t)}),i.length&&e.setCurrent(shuffle(i)[0]),0===i.length||e.current.q===t.q||e.t(e.current)>-1?void 0:timeout(150,arguments.callee)})},this["double"]=function(t){return-1===this.t(this.toc(t))||this.doubleStore===t?!0:(this.doubleStore=t,!1)},this.points=function(t){return function(){var i,n;for(n=[],s=i=0;5>=i;s=++i)n.push(this.corner(t,this.options.size,s).join(","));return n}.call(this).join(" ")},this.corner=function(t,i,n){var e;return e=Math.PI/180*60*n,[t.x+i*Math.cos(e),t.y+i*Math.sin(e)]},this.c=function(t,i){return{q:t,r:i}},this.t=function(t){return this.tiles[this.tok(t)]},this.set=function(t,i){return null==i&&(i=!1),this.tiles[this.tok(t)]=i},this.get=function(t){return null!=(r=this.lookup[this.t(t)])?r:!1},this.tok=function(t){return t.q+"-"+t.r},this.toc=function(t){var i;return i=t.split("-").map(parseFloat),this.c(i[0],i[1])},this.find=function(t){var i;return function(){var n,e,s,r;for(r=[],i=n=0,e=2*this.options.distance;e>=0?e>=n:n>=e;i=e>=0?++n:--n)(s=this.t(this.c(t,i)))!==!1&&-1!==s&&r.push(this.c(t,i));return r}.call(this)[0]},this.next=function(t,i){return null==i&&(i=!1),[-1,0].map(function(n){return e.c(t.q+(i?-1:1),t.r+n+t.q%2)}).filter(function(t){var i,n;return i=t.r,__indexOf.call(function(){n=[];for(var t=0,i=2*e.options.distance;i>=0?i>=t:t>=i;i>=0?t++:t--)n.push(t);return n}.apply(this),i)>=0})},this.cube=function(t){var i,n,e;return e=[t.q,t.r-(t.q-(1&t.q))/2],i=e[0],n=e[1],{x:i,z:n,y:-i-n}},this["in"]=function(t,i,n){var e,r,h,o,u,l,a,c,f,p,d,g,v,q,m;return n.q<i.q&&(l=[n,i],i=l[0],n=l[1]),a=[t,i,n].map(this.cube),s=a[0],r=a[1],e=a[2],e.y<=r.y&&e.z<=r.z&&(c=s.y,__indexOf.call(function(){g=[];for(var t=f=e.y,i=r.y;i>=f?i>=t:t>=i;i>=f?t++:t--)g.push(t);return g}.apply(this),c)>=0)&&(p=s.z,__indexOf.call(function(){v=[];for(var t=d=e.z,i=r.z;i>=d?i>=t:t>=i;i>=d?t++:t--)v.push(t);return v}.apply(this),p)>=0)&&(h=t.q,__indexOf.call(function(){q=[];for(var t=o=i.q,e=n.q;e>=o?e>=t:t>=e;e>=o?t++:t--)q.push(t);return q}.apply(this),h)>=0)&&(u=t.r,__indexOf.call(function(){m=[];for(var t=0,i=2*this.options.distance;i>=0?i>=t:t>=i;i>=0?t++:t--)m.push(t);return m}.apply(this),u)>=0)},this.area=function(t,i){var n,e,s,r,h;s=this.tiles,h=[];for(n in s)e=s[n],this["in"](this.toc(n),t,i)&&(r=this.toc(n).q)!==t.q&&r!==i.q&&h.push(this.toc(n));return h},this.draw=function(t,i){var n,s,r,h,o,u,l,a,c,f,p;for(n=t,a=i.q<t.q?function(){f=[];for(var n=u=i.q,e=t.q-2;e>=u?e>=n:n>=e;e>=u?n++:n--)f.push(n);return f}.apply(this):function(){p=[];for(var n=l=t.q,e=i.q-2;e>=l?e>=n:n>=e;e>=l?n++:n--)p.push(n);return p}.apply(this),c=[],h=0,o=a.length;o>h;h++)r=a[h],c.push((s=this.next(n,t.q>i.q).filter(function(n){var s;return e["in"](n,t,i)&&((s=e.t(n))===!1||-1===s)})).length?this.set(n=shuffle(s)[0],-1):void 0);return c},this.dist=function(t,i){var n,e,s;return s=[t,i].map(this.cube),n=s[0],e=s[1],(Math.abs(n.x-e.x)+Math.abs(n.y-e.y)+Math.abs(n.z-e.z))/2},this.generate=function(){var t,n,h,o,u,l,a,c,f,p,d,g,v,q,m,x,y,b,_,w,M,k,O,z,C,E,A,L,P,S,T,F,I,H,j,D,G,N,R,B,V,X,Y,J,K,Q;for(M=function(){var t,i,n,e;for(n=this.data,e=[],t=0,i=n.length;i>t;t++)r=n[t],e.push(r.step);return e}.call(this).filter(function(t,i,n){return n.indexOf(t)===i}).sort(function(t,i){return i>t?-1:1}),G=[shuffle(this.data.slice(0)),[]],i=G[0],o=G[1],s=z=0,A=M.length;A>z;s=++z)for(w=M[s],d=i.filter(function(t){return t.step===w}),N=[d.filter(function(t){return t.checkpoint}),d.filter(function(t){return!t.checkpoint})],u=N[0],q=N[1],n=4+Math.ceil(Math.max(1,Math.floor(2*q.length/3))/u.length)-1,"tutoriel"===u[0].context&&u.sort(function(t,i){return t.id<i.id?-1:1}),g=C=0,L=u.length;L>C;g=++C){for(r=u[g],l=this.length,(s<M.length-1||g<u.length-1)&&(this.length+=n),y=E=l,R=this.length;R>=l?R>=E:E>=R;y=R>=l?++E:--E)for(b=F=0,B=2*this.options.distance;B>=0?B>=F:F>=B;b=B>=0?++F:--F)this.set(this.c(y,b));o.push(l),v=null!=(x=o[o.indexOf(l)-1])?function(){X=[];for(var t=1,i=2*this.options.distance-1;i>=1?i>=t:t>=i;i>=1?t++:t--)X.push(t);return X}.apply(this).filter(function(t){var i,n,s;return s=[e.c(l,t),e.find(x)].map(e.cube),i=s[0],n=s[1],n.z-i.z>1&&n.y-i.y>1}):function(){Y=[];for(var t=1,i=2*this.options.distance-1;i>=1?i>=t:t>=i;i>=1?t++:t--)Y.push(t);return Y}.apply(this),this.set(this.c(l,shuffle(v)[0]),r.id)}for(_=0,J=[],I=0,P=M.length;P>I;I++){for(w=M[I],d=i.filter(function(t){return t.step===w}),q=[],V=[_+d.filter(function(t){return t.checkpoint}).length,d.filter(function(t){return!t.checkpoint})],a=V[0],q=V[1],y=H=0,S=o.length;S>H;y=++H)if(h=o[y],__indexOf.call(function(){K=[];for(var t=_,i=a-1;i>=_?i>=t:t>=i;i>=_?t++:t--)K.push(t);return K}.apply(this),y)>=0)if(j=[this.find(h),this.find(o[y+1])],m=j[0],k=j[1],0===q.length)this.draw(m,k);else if(1===q.length)this.draw(m,k),this.set(shuffle(this.area(m,k)).filter(function(t){return e.dist(m,t)>=2&&e.dist(k,t)>=2&&-1===e.t(t)})[0],q.shift().id);else{for(D=[[m,k],shuffle(this.area(m,k))],f=D[0],t=D[1];O=t.shift();)f.filter(function(t){return e.dist(O,t)>=2}).length===f.length&&__indexOf.call(f,O)<0&&f.push(O);for(f=f.sort(function(t,i){return t.q<i.q?-1:1}).concat(f.slice(0).reverse()),p=Q=0,T=f.length;T>Q;p=++Q)if(c=f[p],p<f.length-1){for(q.length&&this.t(c)===!1&&this.set(c,q.shift().id),g=1;0===this.area(c,f[p+g]).length;)g++;this.draw(c,f[p+g])}}J.push(_=a)}return J},this.init(),this};
